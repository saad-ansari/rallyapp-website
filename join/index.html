<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Join Squad on Rally</title>
    <meta
      name="description"
      content="You've been invited to join a squad on Rally - the app that makes plans actually happen."
    />

    <!-- Open Graph -->
    <meta property="og:title" content="Join a Squad on Rally" />
    <meta
      property="og:description"
      content="You've been invited to join a squad. Download Rally to connect with friends who actually show up."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://rallyapp.me/join/" />
    <meta
      property="og:image"
      content="https://rallyapp.me/images/rally-logo.png"
    />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Join a Squad on Rally" />
    <meta
      name="twitter:description"
      content="You've been invited to join a squad. Download Rally to connect with friends who actually show up."
    />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/favicon.png" />
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <!-- Styles -->
    <link rel="stylesheet" href="/css/style.css" />

    <style>
      /* Join Page Specific Styles */
      .join-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-8);
        text-align: center;
      }

      .join-card {
        max-width: 420px;
        width: 100%;
        background: var(--color-bg-elevated);
        border-radius: var(--radius-2xl);
        padding: var(--space-10);
        box-shadow: var(--shadow-xl), var(--shadow-glow);
        border: 1px solid var(--color-border-subtle);
      }

      .join-logo {
        width: 72px;
        height: 72px;
        margin: 0 auto var(--space-6);
        border-radius: var(--radius-xl);
        overflow: hidden;
        box-shadow: 0 4px 14px rgba(234, 88, 12, 0.35);
      }

      .join-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .join-title {
        font-size: var(--text-title);
        font-weight: 800;
        margin-bottom: var(--space-3);
        letter-spacing: -0.02em;
      }

      .squad-name {
        color: var(--color-primary);
      }

      .join-subtitle {
        font-size: var(--text-body);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-8);
        line-height: 1.6;
      }

      .squad-meta {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        font-size: var(--text-caption);
        color: var(--color-text-tertiary);
        margin-bottom: var(--space-6);
      }

      .squad-meta-dot {
        width: 4px;
        height: 4px;
        background: var(--color-text-tertiary);
        border-radius: 50%;
      }

      .invite-code-box {
        background: var(--color-bg-subtle);
        border: 2px dashed var(--color-border-default);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        margin-bottom: var(--space-8);
      }

      .invite-code-label {
        font-size: var(--text-micro);
        font-weight: 600;
        color: var(--color-text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: var(--space-2);
      }

      .invite-code-value {
        font-size: 1.75rem;
        font-weight: 800;
        font-family: "SF Mono", "Menlo", "Monaco", monospace;
        letter-spacing: 0.15em;
        color: var(--color-primary);
      }

      .store-buttons {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
        margin-bottom: var(--space-6);
      }

      .store-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-3);
        padding: var(--space-4) var(--space-6);
        background: var(--color-text-primary);
        color: white;
        border-radius: var(--radius-lg);
        font-weight: 600;
        font-size: var(--text-body-sm);
        text-decoration: none;
        transition: all var(--transition-base);
      }

      .store-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .store-button svg {
        width: 24px;
        height: 24px;
      }

      .open-app-link {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        color: var(--color-primary);
        font-weight: 600;
        font-size: var(--text-body-sm);
        text-decoration: none;
        padding: var(--space-3) var(--space-5);
        border-radius: var(--radius-full);
        transition: all var(--transition-base);
      }

      .open-app-link:hover {
        background: var(--color-primary-muted);
      }

      .join-instructions {
        margin-top: var(--space-8);
        padding-top: var(--space-6);
        border-top: 1px solid var(--color-border-subtle);
      }

      .join-instructions h3 {
        font-size: var(--text-body-sm);
        font-weight: 700;
        margin-bottom: var(--space-4);
        color: var(--color-text-primary);
      }

      .instruction-steps {
        text-align: left;
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .instruction-steps li {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        font-size: var(--text-caption);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-3);
      }

      .instruction-steps li:last-child {
        margin-bottom: 0;
      }

      .step-number {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--color-primary-muted);
        color: var(--color-primary);
        font-size: var(--text-micro);
        font-weight: 700;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .footer-note {
        margin-top: var(--space-8);
        font-size: var(--text-caption);
        color: var(--color-text-tertiary);
      }

      .footer-note a {
        color: var(--color-primary);
        text-decoration: none;
      }

      .footer-note a:hover {
        text-decoration: underline;
      }

      /* Loading state */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid var(--color-border-default);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Error state */
      .error-state {
        color: #ef4444;
      }

      .error-icon {
        width: 72px;
        height: 72px;
        margin: 0 auto var(--space-6);
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fef2f2;
        border-radius: var(--radius-xl);
        font-size: 2rem;
      }

      .error-title {
        color: #dc2626;
      }

      /* Hide elements initially */
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- Background Orbs -->
    <div class="orbs-container">
      <div class="orb orb-1"></div>
      <div class="orb orb-2"></div>
      <div class="orb orb-3"></div>
    </div>

    <!-- Grain Overlay -->
    <div class="grain-overlay"></div>

    <!-- Main Content -->
    <main class="join-page">
      <div class="join-card">
        <!-- Loading State -->
        <div id="loadingState">
          <div class="join-logo"><img src="/images/rally-logo.png" alt="Rally" /></div>
          <h1 class="join-title">Loading...</h1>
          <p class="join-subtitle">
            <span class="loading-spinner"></span>
          </p>
        </div>

        <!-- Success State -->
        <div id="successState" class="hidden">
          <!-- Logo -->
          <div class="join-logo"><img src="/images/rally-logo.png" alt="Rally" /></div>

          <!-- Title -->
          <h1 class="join-title">
            Join <span class="squad-name" id="squadName"></span>
          </h1>
          <p class="join-subtitle" id="inviteMessage">
            You've been invited to join this squad on Rally — the app that makes
            plans actually happen.
          </p>

          <!-- Squad Meta -->
          <div class="squad-meta" id="squadMeta">
            <span id="invitedBy">Invited by someone</span>
            <span class="squad-meta-dot"></span>
            <span id="memberCount">1 member</span>
          </div>

          <!-- Invite Code -->
          <div class="invite-code-box">
            <div class="invite-code-label">Your Invite Code</div>
            <div class="invite-code-value" id="inviteCode">------</div>
          </div>

          <!-- App Store Buttons -->
          <div class="store-buttons">
            <a
              href="https://apps.apple.com/app/rally-app/id123456789"
              class="store-button"
              id="appStoreLink"
            >
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"
                />
              </svg>
              Download on App Store
            </a>
            <a
              href="https://play.google.com/store/apps/details?id=com.rally.app"
              class="store-button"
              id="playStoreLink"
            >
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M3,20.5V3.5C3,2.91 3.34,2.39 3.84,2.15L13.69,12L3.84,21.85C3.34,21.6 3,21.09 3,20.5M16.81,15.12L6.05,21.34L14.54,12.85L16.81,15.12M20.16,10.81C20.5,11.08 20.75,11.5 20.75,12C20.75,12.5 20.53,12.9 20.18,13.18L17.89,14.5L15.39,12L17.89,9.5L20.16,10.81M6.05,2.66L16.81,8.88L14.54,11.15L6.05,2.66Z"
                />
              </svg>
              Get it on Google Play
            </a>
          </div>

          <!-- Already have the app? -->
          <a href="#" class="open-app-link" id="openAppLink">
            Already have Rally? Open App
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M5 12h14M12 5l7 7-7 7" />
            </svg>
          </a>

          <!-- Instructions -->
          <div class="join-instructions">
            <h3>How to join:</h3>
            <ol class="instruction-steps">
              <li>
                <span class="step-number">1</span>
                <span>Download Rally from the App Store or Google Play</span>
              </li>
              <li>
                <span class="step-number">2</span>
                <span>Create your account or sign in</span>
              </li>
              <li>
                <span class="step-number">3</span>
                <span
                  >Tap "Join Squad" and enter the code:
                  <strong id="codeInstructions">...</strong></span
                >
              </li>
            </ol>
          </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden">
          <div class="error-icon">❌</div>
          <h1 class="join-title error-title">Invalid Invite Link</h1>
          <p class="join-subtitle">
            This invite code doesn't exist or may have expired. Please ask your
            friend for a new invite link.
          </p>

          <!-- Still show download buttons -->
          <div class="store-buttons" style="margin-top: var(--space-8)">
            <a
              href="https://apps.apple.com/app/rally-app/id123456789"
              class="store-button"
            >
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"
                />
              </svg>
              Download on App Store
            </a>
            <a
              href="https://play.google.com/store/apps/details?id=com.rally.app"
              class="store-button"
            >
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M3,20.5V3.5C3,2.91 3.34,2.39 3.84,2.15L13.69,12L3.84,21.85C3.34,21.6 3,21.09 3,20.5M16.81,15.12L6.05,21.34L14.54,12.85L16.81,15.12M20.16,10.81C20.5,11.08 20.75,11.5 20.75,12C20.75,12.5 20.53,12.9 20.18,13.18L17.89,14.5L15.39,12L17.89,9.5L20.16,10.81M6.05,2.66L16.81,8.88L14.54,11.15L6.05,2.66Z"
                />
              </svg>
              Get it on Google Play
            </a>
          </div>

          <p
            style="
              margin-top: var(--space-6);
              color: var(--color-text-tertiary);
              font-size: var(--text-caption);
            "
          >
            You can still download Rally and join squads with a valid invite
            code.
          </p>
        </div>
      </div>

      <!-- Footer -->
      <p class="footer-note">
        <a href="/">Learn more about Rally</a> ·
        <a href="/privacy.html">Privacy</a> · <a href="/terms.html">Terms</a>
      </p>
    </main>

    <script>
      // Supabase Edge Function URL
      const SUPABASE_URL = "https://luycgijiyhemhtjiggze.supabase.co";

      // Extract invite code from URL (supports both path and query parameter)
      function getInviteCode() {
        // First check query parameter (used when redirected from 404.html)
        const urlParams = new URLSearchParams(window.location.search);
        const codeFromQuery = urlParams.get("code");
        if (codeFromQuery) {
          return codeFromQuery.toUpperCase();
        }

        // Then check path (for direct access if server supports it)
        const path = window.location.pathname;
        const match = path.match(/\/join\/([A-Za-z0-9]+)/);
        return match ? match[1].toUpperCase() : null;
      }

      // Fetch squad preview from API
      async function fetchSquadPreview(inviteCode) {
        try {
          const response = await fetch(
            `${SUPABASE_URL}/functions/v1/get-squad-preview?code=${inviteCode}`,
          );
          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error fetching squad preview:", error);
          return { isValid: false, error: "Network error" };
        }
      }

      // Show success state
      function showSuccess(inviteCode, squadData) {
        document.getElementById("loadingState").classList.add("hidden");
        document.getElementById("errorState").classList.add("hidden");
        document.getElementById("successState").classList.remove("hidden");

        // Update squad name
        document.getElementById("squadName").textContent = squadData.name;

        // Update invite message
        document.getElementById("inviteMessage").textContent =
          `${squadData.creatorName} invited you to join ${squadData.name} on Rally — the app that makes plans actually happen.`;

        // Update meta info
        document.getElementById("invitedBy").textContent =
          `Invited by ${squadData.creatorName}`;
        document.getElementById("memberCount").textContent =
          squadData.memberCount === 1
            ? "1 member"
            : `${squadData.memberCount} members`;

        // Update invite code displays
        document.getElementById("inviteCode").textContent = inviteCode;
        document.getElementById("codeInstructions").textContent = inviteCode;

        // Set deep link for "Open App" button
        document.getElementById("openAppLink").href =
          "rally://join/" + inviteCode;

        // Update page title
        document.title = `Join ${squadData.name} on Rally`;
      }

      // Show error state
      function showError() {
        document.getElementById("loadingState").classList.add("hidden");
        document.getElementById("successState").classList.add("hidden");
        document.getElementById("errorState").classList.remove("hidden");
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", async function () {
        const inviteCode = getInviteCode();

        if (!inviteCode) {
          showError();
          return;
        }

        // Fetch squad preview
        const squadData = await fetchSquadPreview(inviteCode);

        if (squadData.isValid) {
          showSuccess(inviteCode, squadData);
        } else {
          showError();
        }

        // Detect platform and highlight appropriate store button
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);

        if (isIOS) {
          document.getElementById("appStoreLink").style.order = "-1";
        } else if (isAndroid) {
          document.getElementById("playStoreLink").style.order = "-1";
        }

        // Try to open app automatically on mobile (with fallback)
        if (squadData.isValid && (isIOS || isAndroid)) {
          const deepLink = "rally://join/" + inviteCode;

          // Create hidden iframe to try opening app
          const iframe = document.createElement("iframe");
          iframe.style.display = "none";
          iframe.src = deepLink;
          document.body.appendChild(iframe);

          // Remove iframe after attempt
          setTimeout(function () {
            document.body.removeChild(iframe);
          }, 2000);
        }
      });
    </script>
  </body>
</html>
